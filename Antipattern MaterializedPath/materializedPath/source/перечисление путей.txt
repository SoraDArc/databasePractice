CREATE TABLE mpath_ak (
	kingdom_id INTEGER PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
	level_kingdom TEXT NOT NULL,
	title TEXT NOT NULL,
	mpath VARCHAR(1000)
);

//Получение всех потомков 1 +
SELECT lpad(' ',5 * (LENGTH(mpath) - LENGTH(REPLACE(mpath, '/', '')))) || title AS formatted_title, level_kingdom,kingdom_id,mpath FROM mpath_ak 
WHERE mpath LIKE (
	SELECT mpath || '%' FROM mpath_ak WHERE kingdom_id = 1
) ORDER BY mpath

//Получение прямых потомков 2 +
SELECT kingdom_id, level_kingdom, title, mpath FROM mpath_ak AS mp WHERE mpath LIKE (SELECT mpath FROM mpath_ak WHERE kingdom_id = 1) || '%'
AND (LENGTH(mpath) - LENGTH(REPLACE(mpath, '/', ''))) = ((SELECT LENGTH(mpath) - LENGTH(REPLACE(mpath, '/', '')) FROM mpath_ak WHERE kingdom_id = 1) + 1)


//Получение всех родителей 3 +
SELECT lpad(' ',5 * (LENGTH(mpath) - LENGTH(REPLACE(mpath, '/', '')))) || title AS formatted_title, level_kingdom,kingdom_id,mpath FROM mpath_ak
WHERE (
	SELECT mpath FROM mpath_ak WHERE kingdom_id = 10
) LIKE mpath || '%'

//Получение прямого родителя 4 +
SELECT * FROM mpath_ak WHERE mpath LIKE (
SELECT SUBSTRING(mpath, 1, length(SUBSTRING(mpath,1,length(mpath)-1)) - strpos(reverse(SUBSTRING(mpath,1,length(mpath)-1)), '/') + 1) FROM mpath_ak WHERE kingdom_id = 5
)

//Вставка листа 5 +
-- вставляем узел
INSERT INTO mpath_ak (level_kingdom,title) VALUES ('Класс','Двустворчатые') RETURNING kingdom_id;
-- обновляем путь
UPDATE mpath_ak SET mpath = (
	SELECT mpath FROM mpath_ak WHERE kingdom_id = 11
) || '16 last id' || '/'
WHERE kingdom_id = 16 - last id;

//Удаление листа 6 +
DELETE FROM mpath_ak WHERE id = 6

//Удаление узла 7 +
-- удалим из пути потомков удаляемый узел
UPDATE mpath_ak SET mpath = REPLACE(mpath, '/2/','/')
-- удалим узел
DELETE FROM mpath_ak WHERE kingdom_id = 2

//Удаление поддерева 8 +
DELETE FROM mpath_ak WHERE kingdom_id IN (
	SELECT kingdom_id FROM mpath_ak 
	WHERE mpath LIKE (
		SELECT mpath || '%' FROM mpath_ak WHERE kingdom_id = 2
	)		
)
--IN условие встречи таких то строк string1, string2...

//Перемещение листа 9 +
UPDATE mpath_ak SET mpath = (SELECT mpath FROM mpath_ak WHERE kingdom_id = 1) || kingdom_id || '/' WHERE kingdom_id = 13

//Перемещение узла 10 +
-- удалим из пути потомков перемещаемый узел
UPDATE mpath_ak SET mpath =REPLACE(mpath, '/2/','/')
-- переместим узел
UPDATE mpath_ak SET mpath = (SELECT mpath FROM mpath_ak WHERE kingdom_id = 3) || kingdom_id || '/' WHERE kingdom_id = 2

//Перемещение поддерева 11 +
UPDATE mpath_ak SET mpath = REPLACE(mpath, (SELECT mpath FROM mpath_ak WHERE kingdom_id = 11), (SELECT mpath FROM mpath_ak WHERE kingdom_id = 1)|| '11/')

